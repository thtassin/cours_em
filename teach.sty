% teach V1.6
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{teach}[2019/08/14]
\RequirePackage{xargs} % ajout du 2019/08/14
\RequirePackage{titlesec}
\RequirePackage{graphicx}
\RequirePackage[utf8]{inputenc}
\RequirePackage[table,svgnames]{xcolor}
\RequirePackage{tcolorbox}
\RequirePackage{cellspace}
    \setlength{\cellspacebottomlimit}{4pt}
\RequirePackage{ifthen}
\RequirePackage{multido}
\RequirePackage{tabularx}
\RequirePackage{hyperref}
\RequirePackage[hmargin=2.5cm,vmargin=2cm]{geometry}
\RequirePackage[margin=12pt, labelsep=endash, font=footnotesize, labelfont=bf]{caption}
\RequirePackage{mytheme}
% -----------------------------------
% Options
% -----------------------------------

\newif\if@minitoc
\DeclareOption{minitoc}{\@minitoctrue}

\newif\if@titre
\DeclareOption{titre}{\@titretrue}

\newif\if@samecountexo
\DeclareOption{samecountexo}{\@samecountexotrue}

\ProcessOptions

% Minitoc
\if@minitoc
    \RequirePackage{minitoc}    
    \renewcommand{\mtctitle}{} 
\fi

% --------------------------------------------
% Divers commandes
% --------------------------------------------
\renewcommand{\emph}[1]{\textcolor{\teach@emph@color}{\textbf{#1}}}

% ---------------------------------------------
% New length
% ---------------------------------------------
\newlength\arrayvertrulewidth
\setlength{\arrayvertrulewidth}{2pt}
\newlength\arrayhspace
\setlength{\arrayhspace}{5pt}

% ---------------------------------------------
% New list
% ---------------------------------------------
\RequirePackage{enumitem}

% Remarques 
\newlist{remslist}{itemize}{1}
\setlist[remslist,1]{%
             labelsep=*,
             label=\textbullet,
             leftmargin=16pt,
             labelindent=0pt}

% Exemple
\newlist{exempleslist}{enumerate}{1}
\setlist[exempleslist,1]{%
            labelsep=*,
            label=\protect\fontfamily{lmss}\protect\bfseries\protect\selectfont\arabic*.,
            leftmargin=16pt,
            labelindent=0pt
            }
\newlist{exemplelist}{itemize}{1}
\setlist[exemplelist,1]{%
            labelsep=*,
            label=\textcolor{\teach@exemple@title@txtcolor}{\textbullet},
            leftmargin=16pt,
            labelindent=0pt
            }

% Exercice
\newlist{exolist}{enumerate}{2}
\setlist[exolist,1]{%
                    labelsep=*,
                    label=\protect\bfseries\protect\selectfont\arabic*.,
                    leftmargin=16pt,
                    labelindent=0pt
                   }

\setlist[exolist,2]{%
                    labelsep=*,
                    label=\protect\bfseries\protect\selectfont\alph*.,
                    leftmargin=16pt,
                    labelindent=-4pt
                   }

% Définition
\newlist{defitemize}{itemize}{1}
\setlist[defitemize,1]{%
                       labelsep=*,
                       label=$\blacktriangleright$,
                       leftmargin=16pt,
                       labelindent=0pt
                      }

\newlist{defenumerate}{enumerate}{1}
\setlist[defenumerate,1]{%
                         labelsep=*,
                         label=\protect\bfseries\protect\selectfont\arabic*.,
                         leftmargin=16pt,
                         labelindent=-4pt
                         }


% -------------------------------------------------------
% Chapter, Section, ...
% -------------------------------------------------------
% Chapter
    \titleformat{\chapter}[block]
     {\Large\bfseries\color{\teach@chapter@global@color}\vspace*{-2cm}}
     {\raisebox{-\height}{\sffamily\scriptsize\MakeUppercase{\chaptertitlename}}%
  \space\raisebox{-\height}{\bigchapternumber}\space}
 {0pt}
 {\printtitle}

\newlength\pretitlewidth
\newcommand\bigchapternumber{\resizebox{24pt}{!}{\mdseries\sffamily\thechapter}}
\newcommand{\printtitle}[1]{%
  \settowidth{\pretitlewidth}{%
    {\sffamily\scriptsize\MakeUppercase{\chaptertitlename}}\space
    {\bigchapternumber}\space
  }%
  \ifnum\thechapter>0
      \parbox[t]{\dimexpr\textwidth-\pretitlewidth}{%
        \linespread{1.5}\selectfont
        \hrule depth 1pt
        \vspace{2ex}
        \raggedright\Huge\sffamily\bfseries #1
      }%
      \else
          \parbox[t]{\dimexpr\textwidth}{%
        \linespread{1.5}\selectfont
        \hrule depth 1pt
        \vspace{2ex}
        \raggedright\Huge\sffamily\bfseries #1
          }%
  \fi
  \vspace{1em}

 \hrule depth 1pt
 \if@minitoc
     \color{\teach@minitoc@global@color}
     \ifnum\thechapter>0
         \vspace{1em}
         \fontfamily{lmss}\bfseries\selectfont Plan de ce chapitre\par 
         \minitoc
     \fi
 \fi
}

% Section
\renewcommand{\thesection}{\Roman{section}.}
\renewcommand\section{\@startsection {section}{1}{\z@}%
     {-2.0ex \@plus -1ex \@minus -.2ex}%  before skip
     {1.3ex \@plus.2ex}% after skip
     {\color{\teach@section@title@txtcolor}\normalfont\Large\bfseries}}

% Subsection
\renewcommand{\thesubsection}{\arabic{subsection}.}
\renewcommand\subsection{\@startsection{subsection}{2}{\z@}%
{-2.25ex\@plus -1ex \@minus -.2ex}% 
{1.0ex \@plus .2ex}%
{\normalfont\large\bfseries}}

% Subsubsection
\setcounter{secnumdepth}{4}
\renewcommand{\thesubsubsection}{\arabic{subsection}. \alph{subsubsection}.}
\renewcommand\subsubsection{\@startsection{subsubsection}{3}{\z@}%
     {-2.0ex\@plus -1ex \@minus -.2ex}% 
     {0.75ex \@plus .2ex}%
     {\normalfont\normalsize\bfseries}}

% ------------------------
% Fancyhead
% ------------------------
\def\author{}
\def\group{}
\def\title{}
\RequirePackage{fancyhdr}
\lhead[\fancyplain{}{\bfseries\thepage}]{\fancyplain{}{\nouppercase{\bfseries\leftmark}}}
\rhead[\fancyplain{}{\nouppercase{\rightmark}}]{\fancyplain{}{\bfseries\thepage}}
\fancyfoot{}
\fancyfoot[LE,RO]{\itshape\group}
\pagestyle{fancyplain}


% -----------------------------------
% Environnements
% -----------------------------------
\def\teach@title@exemple{Exemple}
\def\teach@title@rem{Remarque}
\def\teach@title@rems{Remarques}
\def\teach@title@exo{Exercice}
\def\teach@title@memento{À retenir}
\def\teach@title@attention{Attention}
\def\redefinetitle#1#2{\expandafter\renewcommand\csname teach@title@#1\endcsname{#2}}

% Part

\renewcommand*\part[1]
{%
\ifnum \c@secnumdepth >\m@ne
  \refstepcounter{part}%
\fi
    \addtocontents{toc}{%
        \bgroup%
        \color{teal}
        \protect\contentsline{part}{\hspace*{-2.5em}\numberline{}\scshape\Large#1\hspace*{1ex}\hrulefill}{}{}    
        \egroup}
    \newgeometry{margin=2cm}
    \color{white}
    \AddToShipoutPictureBG*{%
        \AtPageLowerLeft{%
                \put(0,0){\includegraphics{part.jpg}}
        }
    }
    \thispagestyle{empty}%
      \begin{flushright}
          \fontfamily{lmss}
          \fontsize{50}{54}
          \fontseries{bx}
          \selectfont
          \partname\nobreakspace\thepart\\[1cm]#1
      \end{flushright}
      \color{black}
     \newpage
    \restoregeometry
}

% Boîtes

\newsavebox{\teach@box}

% Macro pour les titres

\newcommand{\teach@title}{}

% Définition

\newcounter{count@defn}[chapter]
\newlength\teach@defn@box@height
\newlength\teach@defn@box@depth
\newlength\teach@defn@title@width
\newenvironment{defn}[1][]
{%
\refstepcounter{count@defn}
\let\itemize\defitemize
\let\enumerate\defenumerate
\begin{lrbox}{\teach@box}
\begin{minipage}{\linewidth}
\begin{tcolorbox}[arc=1ex, colback=\teach@defn@bg@textcolor, 
       colframe=\teach@defn@bg@textcolor, left=3pt,
       right=3pt, top=3pt, bottom=2pt]
\textbf{#1 :}

}
{
\end{tcolorbox}
\end{minipage}
\end{lrbox}
\vspace{1em}
\usebox{\teach@box}
\vspace{1em}
}

% breakex (ajout du 29/10/2018)

\newcommand{\breakex}[1][\thecount@item]
{%
\ifnum\theindic@exemple@pluriel=1
\end{exempleslist}
\end{minipage}
\end{lrbox}
\vspace{1em}\arrayrulecolor{\teach@exemple@title@txtcolor}
\begin{tabular}{|@{}Sl@{}}
\multicolumn{1}{@{}l}{\fontfamily{lmss}\bfseries\selectfont\fcolorbox{\teach@exemple@title@txtcolor}{\teach@exemple@title@bgcolor}{\textcolor{\teach@exemple@title@txtcolor}{\teach@title\strut}}} \\
\begin{tabular}{Sl@{}}
 \\[-10pt]
\usebox{\teach@box}
\end{tabular}
\end{tabular}\par 
\edef\tmptitle{\teach@title}
\renewcommand{\teach@title}{\tmptitle{} -- Suite}
\begin{lrbox}{\teach@box}
\begin{minipage}{\dimexpr\linewidth-2\tabcolsep+6pt}
\color{\teach@exemple@body@txtcolor}
\restartlist{exempleslist}
\begin{exempleslist}[start=#1]
\else
\end{minipage}
\end{lrbox}
\vspace{1em}\arrayrulecolor{\teach@exemple@title@txtcolor}
\begin{tabular}{|@{}Sl@{}}
\multicolumn{1}{@{}l}{\fontfamily{lmss}\bfseries\selectfont\fcolorbox{\teach@exemple@title@txtcolor}{\teach@exemple@title@bgcolor}{\textcolor{\teach@exemple@title@txtcolor}{\teach@title\strut}}} \\
\begin{tabular}{Sl@{}}
 \\[-10pt]
\usebox{\teach@box}
\end{tabular}
\end{tabular}\par 
\edef\tmptitle{\teach@title}
\renewcommand{\teach@title}{\tmptitle{} -- Suite}
\begin{lrbox}{\teach@box}
\begin{minipage}{\dimexpr\linewidth-2\tabcolsep+6pt}
\color{\teach@exemple@body@txtcolor}
\fi
}

% Exemple

\newcounter{count@exemple}[chapter]
\newcounter{indic@exemple@pluriel}
\newenvironment{exemple}[1][]
{%
\setcounter{indic@exemple@pluriel}{0}
\refstepcounter{count@exemple}
\ifx\hfuzz#1\hfuzz
\renewcommand\teach@title{\teach@title@exemple~\thecount@exemple}
\else
\renewcommand\teach@title{\teach@title@exemple~\thecount@exemple~(#1)}
\fi
\let\itemize\exemplelist
\begin{lrbox}{\teach@box}
\begin{minipage}{\dimexpr\linewidth-2\tabcolsep+6pt}
\color{\teach@exemple@body@txtcolor}
}
{
\end{minipage}
\end{lrbox}
\vspace{1em}\arrayrulecolor{\teach@exemple@title@txtcolor}
\begin{tabular}{|@{}Sl@{}}
\multicolumn{1}{@{}l}{\fontfamily{lmss}\bfseries\selectfont\fcolorbox{\teach@exemple@title@txtcolor}{\teach@exemple@title@bgcolor}{\textcolor{\teach@exemple@title@txtcolor}{\teach@title\strut}}} \\
\begin{tabular}{Sl@{}}
 \\[-10pt]
\usebox{\teach@box}
\end{tabular}
\end{tabular}\arrayrulecolor{black}
\vspace{1em}
}

% Exemples
\newcounter{count@item}
\newenvironment{exemples}[1][]
{%
\setcounter{count@item}{1}
\let\itemtmp\item 
\renewcommand{\item}{\itemtmp\stepcounter{count@item}}
\refstepcounter{count@exemple}
\setcounter{indic@exemple@pluriel}{1}
\ifx\hfuzz#1\hfuzz
\renewcommand\teach@title{\teach@title@exemples~\thecount@exemple}
\else
\renewcommand\teach@title{\teach@title@exemples~\thecount@exemple~(#1)}
\fi
\begin{lrbox}{\teach@box}
\begin{minipage}{\dimexpr\linewidth-2\tabcolsep+6pt}
\color{\teach@exemple@body@txtcolor}
\begin{exempleslist}
}
{
\end{exempleslist}
\end{minipage}
\end{lrbox}
\vspace{1em}\arrayrulecolor{\teach@exemple@title@txtcolor}
\begin{tabular}{|@{}Sl@{}}
\multicolumn{1}{@{}l}{\fontfamily{lmss}\bfseries\selectfont\fcolorbox{\teach@exemple@title@txtcolor}{\teach@exemple@title@bgcolor}{\textcolor{\teach@exemple@title@txtcolor}{\teach@title\strut}}} \\
\begin{tabular}{Sl@{}}
 \\[-10pt]
\usebox{\teach@box}
\end{tabular}
\end{tabular}\arrayrulecolor{black}
\vspace{1em}
\let\item\itemtmp
}

% Exercices

\newcounter{count@exo}[chapter]
\newenvironment{exo}[1][]
{%
\refstepcounter{count@exo}
\ifx\hfuzz#1\hfuzz
\renewcommand\teach@title{\teach@title@exo~\thecount@exo.}
\else
\renewcommand\teach@title{\teach@title@exo~\thecount@exo~(#1).}
\fi
\let\enumerate\exolist
\vspace{1em}
\begin{tabular}{@{\color{\teach@exo@rule@color}\vrule width \arrayvertrulewidth\hspace*{\arrayhspace}}l@{}}
\begin{minipage}{\dimexpr\linewidth-\arrayhspace-\arrayvertrulewidth}
\bgroup\fontfamily{lmss}\bfseries\selectfont 
\textcolor{\teach@exo@title@txtcolor}{\teach@title}\egroup
\par 
\color{\teach@exo@body@txtcolor}
}
{
\end{minipage}
\end{tabular}
\vspace{1em}
}

% Exercices corrigés

\newcounter{count@exocor}[chapter]
\newenvironment{exocor}[1][]
{%
\if@samecountexo
    \refstepcounter{count@exo}
    \label{enonce\thechapter\thecount@exo}
    \def\counttmp{\thecount@exo}
\else 
    \refstepcounter{count@exocor}
    \label{enonce\thechapter\thecount@exocor}
    \def\counttmp{\thecount@exocor}
\fi
\ifx\hfuzz#1\hfuzz
\renewcommand\teach@title{\teach@title@exo~\counttmp.}
\else
\renewcommand\teach@title{\teach@title@exo~\counttmp~(#1).}
\fi
\let\enumerate\exolist
\vspace{1em}
\begin{tabular}{@{\color{\teach@exo@rule@color}\vrule width \arrayvertrulewidth\hspace*{\arrayhspace}}l@{}}
\begin{minipage}{\dimexpr\linewidth-\arrayhspace-\arrayvertrulewidth}
\bgroup
\fontfamily{lmss}\selectfont
\bgroup
\bfseries 
\textcolor{\teach@exo@title@txtcolor}{\teach@title}
\egroup
\hfill
\hyperref[corrige\thechapter\counttmp]
    {\small\texttt{[Corrig\'e page \pageref{corrige\thechapter\counttmp}]}}
\egroup
\par 
}
{
\end{minipage}
\end{tabular}
\vspace{1em}
}

\newcommand{\breakexo}
{
\end{minipage}
\end{tabular}
\\[2mm]
\begin{tabular}{@{\color{\teach@exo@rule@color}\vrule width \arrayvertrulewidth\hspace*{0mm}}l@{}}~\end{tabular}
\\[2mm]
\begin{tabular}{@{\color{\teach@exo@rule@color}\vrule width \arrayvertrulewidth\hspace*{0mm}}l@{}}~\end{tabular}
\newpage
\begin{tabular}{@{\color{\teach@exo@rule@color}\vrule width \arrayvertrulewidth\hspace*{0mm}}l@{}}~\end{tabular}
\\[2mm]
\begin{tabular}{@{\color{\teach@exo@rule@color}\vrule width \arrayvertrulewidth\hspace*{0mm}}l@{}}~\end{tabular}
\\[2mm]
\begin{tabular}{@{\color{\teach@exo@rule@color}\vrule width \arrayvertrulewidth\hspace*{\arrayhspace}}l@{}}
\begin{minipage}{\dimexpr\linewidth-\arrayhspace-\arrayvertrulewidth}
}

% Corrigés

\newcounter{count@corrige}[chapter]
\newenvironment{corrige}[1][]
{%
\ifx\hfuzz#1\hfuzz

\ifnum\thecount@corrige=0
    \refstepcounter{count@corrige}
    \setcounter{count@exocor}{1}
\else
    \refstepcounter{count@exocor}
\fi
\def\countcorrigetmp{\thecount@exocor}
\else
\def\countcorrigetmp{#1}
\fi
\label{corrige\thechapter\countcorrigetmp}
\bgroup
\fontfamily{lmss}\selectfont
\textbf{\textcolor
    {\teach@exo@title@txtcolor}
    {Corrigé de l'exercice \countcorrigetmp. }}
\hfill
\hyperref[enonce\thechapter\countcorrigetmp]{\color{red}\small\texttt{\textit{[Retour \`a l'\'enonc\'e]}}}
\egroup
\par\medskip
\let\enumerate\exolist
}
{\vspace*{2em}}

% Memento % modification au 2019/08/14

\newenvironment{memento}
{
\begin{lrbox}{\teach@box}
\begin{minipage}{\dimexpr\linewidth-3\tabcolsep-0.2pt}
\color{\teach@thm@body@txtcolor}
}
{
\end{minipage}
\end{lrbox}
\vspace{1em}
\begin{tabular}{@{}p{2mm}@{\color{\teach@memento@title@txtcolor}\hspace*{1mm}\vrule width \arrayvertrulewidth\hspace*{\arrayhspace}}Sl@{}}
    \multicolumn{2}{@{}l}{\raisebox{-2mm}{\includegraphics[decodearray={\colortmppicto}]{LOGO/memento.pdf}}~\raisebox{1mm}{\fontfamily{lmss}\bfseries\selectfont\textcolor{\teach@memento@title@txtcolor}{\teach@title}}}\\[-2pt]
 & \usebox{\teach@box}
\end{tabular}
\vspace{1em}
}


% Attention % modification au 2019/08/14

\newenvironment{attention}
{%
\begin{lrbox}{\teach@box}
\begin{minipage}{\dimexpr\linewidth-3\tabcolsep-0.2pt}
\color{\teach@attention@title@txtcolor}
}
{
\end{minipage}
\end{lrbox}
\vspace{1em}
\begin{tabular}{@{}p{2.8mm}@{\color{\teach@attention@title@txtcolor}\hspace*{1mm}\vrule width \arrayvertrulewidth\hspace*{\arrayhspace}}Sl@{}}
\multicolumn{2}{@{}l}{\raisebox{-2mm}{\includegraphics[decodearray={\colortmppicto}]{attention_img.pdf}}~\raisebox{1mm}{\fontfamily{lmss}\bfseries\selectfont\textcolor{\teach@attention@title@txtcolor}{\teach@title}}}\\
& \\[-10pt]
 & \usebox{\teach@box}
\end{tabular}
\vspace{1em}
}


